<html>

<head>
    <link rel="stylesheet" href="CSS\Tablestyle.css" type="text/css" />
    <link rel="stylesheet" href="CSS\ViewStyle.css" type="text/css" />

    <script type="text/javascript" src="Javascripts/hoops_web_viewer.js"></script>
    <script type="text/javascript" src="Javascripts/communicator_server_integration.js"></script>

    <script type="text/javascript" src="Javascripts/common/Example.js"></script>
    <script type="text/javascript" src="Javascripts/common/ModelTree.js"></script>
    <script type="text/javascript" src="Javascripts/common/require.js"></script>

    <script type="text/javascript" src="Javascripts\xCheckStudio\xCheckStudioInterface.js"></script>
    <!-- <script type="text/javascript" src="Javascripts\xCheckStudio\HighlightManager.js"></script> -->
    <script type="text/javascript" src="Javascripts\xCheckStudio\GenericProperties.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\ComponentNodeData.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\CheckManager.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\CheckCaseManager.js"></script>

    <script type="text/javascript" src="Javascripts\jquery\jquery-1.7.1.min.js"></script>

    <style>
        /* The grid: Three equal columns that floats next to each other */
        .column {
            float: left;
            text-align: center;
            width: 100%;
            font-size: 25px;
            cursor: pointer;
            color: white;
        }

        .containerTab {
            padding: 20px;
            color: white;
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        /* Closable button inside the container tab */
        .closebtn {
            float: right;
            color: white;
            font-size: 35px;
            cursor: pointer;

        }

        .collapsible {
            background-color: #777;
            color: white;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
        }

        .active,
        .collapsible:hover {
            background-color: #555;
        }

        .content {
            padding: 0 18px;
            display: none;
            overflow: hidden;
            background-color: #f1f1f1;
        }

        img.button_open {
            content: url('images/button-open.png');
            cursor: pointer;
        }

        img.button_closed {
            content: url('images/button-closed.png');
            cursor: pointer;
        }

        .scrollable {
            overflow: auto;
        }
        </style>
</head>

<body>
    <table style="width: -webkit-fill-available; height:-webkit-fill-available; margin: auto; ">
        <th colspan="2" style=" background-color: #333333; height: 15%;  text-align: center">
            <img src="images/Header.png">

        </th>
        <tr style=" text-align: center">
            <td colspan="2">
                <iframe name="formDestination" height="100px"></iframe>

                <button id="checkButton" disabled="true" onclick="goToReviewModule()"> Check Datasources</button>
                <button onclick="refreshCheck()" id="refreshCheckButton" disabled="true">Refresh Check</button>

            </td>
        </tr>
        <tr style="height: 5%;">
            <td>
                <div class="row" style="margin: auto; width: 50%;">
                    <div class="column" onclick="openTab('b1');" style="background:LightSalmon ;border-radius: 10px">
                        Source A
                    </div>
                </div>
            </td>
            <td>
                <div class="row" style="margin: auto; width: 50%">
                    <div class="column" onclick="openTab('b2');" style="background:lightgreen ; border-radius: 10px">
                        Source B
                    </div>
                </div>
            </td>
        </tr>
        <tr style=" text-align: center">
            <td colspan="2">
                <!-- Full-width columns: (hidden by default) -->
                <div id="b1" class="containerTab" style="display:none;background:LightSalmon; ">
                    <span onclick="this.parentElement.style.display='none'" class="closebtn">&times;</span>
                    <h2>Source A</h2>
                    <div>
                        <!-- First model tree and it's viewer -->
                        <table>
                            <tr>
                                <td></td>
                                <td>
                                    <form action="uploads/uploadfiles.php" method="post" enctype="multipart/form-data"
                                        target="formDestination">
                                        <input id="dataSoures1" name="dataSouresName" type="file" />
                                        <input id="upload1" type="submit" value="Upload">
                                        <button id="load1" onclick="loadModel('dataSoures1', viewerContainer1, modelTree1)">load
                                            model</button>
                                    </form>
                                </td>
                            </tr>
                            <tr>
                                <td valign="top">
                                    <div id="modelTree1"></div>
                                </td>
                                <td>
                                    <div id="viewerContainer1" class="example-canvas-small"></div>
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <div class="viewOrientation2">
                                        <button id="Front1">Front</button>
                                        <button id="Back1">Back</button>
                                        <button id="Top1">Top</button>
                                        <button id="Bottom1">Bottom</button>
                                        <button id="Left1">Left</button>
                                        <button id="Right1">Right</button>
                                        <button id="Iso1">Iso</button>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div id="b2" class="containerTab" style="display:none;background:LightGreen ">
                    <span onclick="this.parentElement.style.display='none'" class="closebtn">&times;</span>
                    <h2>Source B</h2>
                    <div>
                        <!-- second model tree and it's viewer -->
                        <table>
                            <tr>
                                <td></td>
                                <td>
                                    <form action="uploads/uploadfiles.php" method="post" enctype="multipart/form-data"
                                        target="formDestination">
                                        <input id="dataSoures2" name="dataSouresName" type="file" />
                                        <input id="upload2" type="submit" value="Upload">
                                        <button id="load2" onclick="loadModel('dataSoures2', viewerContainer2, modelTree2)">load
                                            model</button>
                                    </form>
                                </td>
                            </tr>
                            <tr>
                                <td valign="top">
                                    <div id="modelTree2"></div>
                                </td>
                                <td>
                                    <div id="viewerContainer2" class="example-canvas-small"></div>
                                </td>
                            </tr>
                            <tr></tr>
                            <tr>
                                <td></td>
                                <td>
                                    <div class="viewOrientation2">
                                        <button id="Front2">Front</button>
                                        <button id="Back2">Back</button>
                                        <button id="Top2">Top</button>
                                        <button id="Bottom2">Bottom</button>
                                        <button id="Left2">Left</button>
                                        <button id="Right2">Right</button>
                                        <button id="Iso2">Iso</button>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
        <th colspan="2" style=" background-color: #333333;  height: 15%;">
        </th>
    </table>

    <script>

        var xCheckStudioInterface1;
        var xCheckStudioInterface2;
        var checkManager;


        window.onload = function () {

            var checkButton = document.getElementById("checkButton");
            checkButton.onclick = function () {

                //virewer container Data
                var viewerOptionsArray1 = [];
                viewerOptionsArray1.push(xCheckStudioInterface1._firstViewer._params.containerId);
                viewerOptionsArray1.push(xCheckStudioInterface1._firstViewer._params.endpointUri);


                localStorage.setItem('viewerContainer1', viewerOptionsArray1)

                var viewerOptionsArray2 = [];
                viewerOptionsArray2.push(xCheckStudioInterface2._firstViewer._params.containerId);
                viewerOptionsArray2.push(xCheckStudioInterface2._firstViewer._params.endpointUri);
                localStorage.setItem('viewerContainer2', viewerOptionsArray2)

                var nodeIdVsComponentDataJSON = [];
                var componentIdVsComponentDataJSON = [];

                nodeIdVsComponentDataJSON = JSON.stringify(xCheckStudioInterface1.nodeIdVsComponentData);
                localStorage.setItem('nodeIdVsComponentData1', nodeIdVsComponentDataJSON);

                componentIdVsComponentDataJSON = JSON.stringify(xCheckStudioInterface1.componentIdVsComponentData);
                localStorage.setItem('componentIdVsComponentData1', componentIdVsComponentDataJSON);

                nodeIdVsComponentDataJSON = JSON.stringify(xCheckStudioInterface1.nodeIdVsComponentData);
                localStorage.setItem('nodeIdVsComponentData2', nodeIdVsComponentDataJSON);

                componentIdVsComponentDataJSON = JSON.stringify(xCheckStudioInterface1.componentIdVsComponentData);
                localStorage.setItem('componentIdVsComponentData2', componentIdVsComponentDataJSON);


                // perform property check
                checkManager = new CheckManager();
                checkManager.checkDataSources(xCheckStudioInterface1.sourceProperties, xCheckStudioInterface2.sourceProperties);

                checkManagerJSON = JSON.stringify(checkManager);
                localStorage.setItem('checkManager', checkManagerJSON);

                window.open("/reviewModule.html", "_blank");
                return false;
            };

            // read check case data from xml configuration file
            readCheckCaseXml();
        };

        function readCheckCaseXml() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    readCheckCaseData(this);
                }
            };

            xhttp.open("GET", "configurations/XML_2_XML_Datamapping.xml", true);
            xhttp.send();
        }

        function readCheckCaseData(xml) {
            var xmlText = xml.responseText;

            var parser = new DOMParser();
            var xmlDoc = parser.parseFromString(xmlText, "application/xml");

            var checkCaseElements = xmlDoc.getElementsByTagName("CheckCase");
            if (checkCaseElements.length < 0) {
                return;
            }

            // check case manager object
            checkCaseManager = new CheckCaseManager();

            var checkCaseElement = checkCaseElements[0];

            // CheckCase object
            var checkCase = new CheckCase(checkCaseElement.getAttribute("name"));

            for (var i = 0; i < checkCaseElement.children.length; i++) {
                var componentGroupElement = checkCaseElement.children[i];
                if (componentGroupElement.localName != "ComponentGroup") {
                    continue;
                }

                // ComponentGroup object
                var checkCaseComponentGroup = new CheckCaseComponentGroup(componentGroupElement.getAttribute("name"));

                for (var j = 0; j < componentGroupElement.children.length; j++) {
                    var componentElement = componentGroupElement.children[j];
                    if (componentElement.localName != "ComponentClass") {
                        continue;
                    }

                    // Component object
                    var checkCaseComponentClass = new CheckCaseComponentClass(componentElement.getAttribute("name"));

                    for (var k = 0; k < componentElement.children.length; k++) {
                        var propertyElement = componentElement.children[k];
                        if (propertyElement.localName != "Property") {
                            continue;
                        }

                        var sourceAProperty = propertyElement.getAttribute("sourceAName");
                        var sourceBProperty = propertyElement.getAttribute("sourceBName");
                        var severity = propertyElement.getAttribute("severity");

                        // create mapping property object 
                        var checkCaseMappingProperty = new CheckCaseMappingProperty(sourceAProperty, sourceBProperty, severity);
                        checkCaseComponentClass.addMappingProperty(checkCaseMappingProperty);
                    }

                    checkCaseComponentGroup.addComponent(checkCaseComponentClass);
                }

                checkCase.addComponentGroup(checkCaseComponentGroup);
            }
            checkCaseManager.addCheckCase(checkCase);
            // checkCaseManagerJSON = JSON.stringify(checkCaseManager);
            // localStorage.setItem('checkCaseManager', checkCaseManagerJSON);
        }

        function openTab(tabName) {
            var tabs = document.getElementsByClassName("containerTab");
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].style.display = "none";
            }

            document.getElementById(tabName).style.display = "block";
        }

        function loadModel(dataSoures, viewerContainer, modelTreeContainer) {

            let selectedFiles = document.getElementById(dataSoures).files;
            let selectedFilesCount = selectedFiles.length;

            let fileName = selectedFiles[0].name;
            fileName = fileName.substring(0, fileName.lastIndexOf('.'));
            fileName += '.scs';

            var uri = "uploads/scs/" + fileName;
            var container_Id = viewerContainer.id;
            var model_Tree = modelTreeContainer.id;

            viewerOptions = {
                containerId: container_Id,
                endpointUri: uri,
                modelTree: model_Tree
            };

            // var viewerOptionsArray = [];
            // viewerOptionsArray.push(viewerOptions.containerId);
            // viewerOptionsArray.push(viewerOptions.endpointUri);

            if (viewerContainer.id === "viewerContainer1") {
                xCheckStudioInterface1 = new xCheckStudio.xCheckStudioInterface();
                xCheckStudioInterface1.setupViewer(viewerOptions, true);

                document.getElementById("load1").disabled = true;
                document.getElementById("upload1").disabled = true;
                document.getElementById("dataSoures1").disabled = true;

                // localStorage.setItem('viewerContainer1', viewerOptionsArray)

            }
            else if (viewerContainer.id === "viewerContainer2") {
                xCheckStudioInterface2 = new xCheckStudio.xCheckStudioInterface();
                xCheckStudioInterface2.setupViewer(viewerOptions, false);

                document.getElementById("load2").disabled = true;
                document.getElementById("upload2").disabled = true;
                document.getElementById("dataSoures2").disabled = true;

                // localStorage.setItem('viewerContainer2', viewerOptionsArray)
            }

            //enable check Button
            document.getElementById("checkButton").disabled = false;

        }


    </script>
</body>

</html>