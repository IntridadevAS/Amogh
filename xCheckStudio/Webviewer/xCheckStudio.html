<html>

<head>
    <title>xCheckStudio</title>

    <script type="text/javascript" src="Javascripts/hoops_web_viewer.js"></script>
    <script type="text/javascript" src="Javascripts/communicator_server_integration.js"></script>

    <script type="text/javascript" src="Javascripts/common/Example.js"></script>
    <script type="text/javascript" src="Javascripts/common/ModelTree.js"></script>
    <script type="text/javascript" src="Javascripts/common/require.js"></script>

    <script type="text/javascript" src="Javascripts\xCheckStudio\xCheckStudioInterface.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\GenericProperties.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\CheckManager.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\ReviewManager.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\ComponentNodeData.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\CheckCaseManager.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\HighlightManager.js"></script>
    <script type="text/javascript" src="Javascripts\xCheckStudio\Utility.js"></script>

    <link rel="stylesheet" href="CSS\ViewStyle.css" type="text/css" />
    <link rel="stylesheet" href="CSS\Tablestyle.css" type="text/css" />

    <script type="text/javascript" src="Javascripts\jquery\jquery-1.7.1.min.js"></script>

    <style type="text/css">
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        /* The grid: Three equal columns that floats next to each other */
        .column {
            float: left;
            width: 50%;
            padding: 50px;
            text-align: center;
            font-size: 25px;
            cursor: pointer;
            color: white;
        }

        .containerTab {
            padding: 20px;
            color: white;
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        /* Closable button inside the container tab */
        .closebtn {
            float: right;
            color: white;
            font-size: 35px;
            cursor: pointer;

        }

        .collapsible {
            background-color: #777;
            color: white;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
        }

        .active,
        .collapsible:hover {
            background-color: #555;
        }

        .content {
            padding: 0 18px;
            display: none;
            overflow: hidden;
            background-color: #f1f1f1;
        }

        img.button_open {
            content: url('images/button-open.png');
            cursor: pointer;
        }

        img.button_closed {
            content: url('images/button-closed.png');
            cursor: pointer;
        }

        .scrollable {
            overflow: auto;
        }
    </style>

</head>

<body>


    <iframe name="formDestination" height="100px"></iframe>

    <button id="checkButton" disabled="true">Check Datasources</button>
    <button onclick="refreshCheck()" id="refreshCheckButton" disabled="true">Refresh Check</button>

    <!-- Three columns -->
    <div class="row">
        <div class="column" onclick="openTab('b1');" style="background:LightSalmon ;">
            Source A
        </div>
        <div class="column" onclick="openTab('b2');" style="background:LightGreen ;">
            Source B
        </div>
    </div>

    <!-- Full-width columns: (hidden by default) -->
    <div id="b1" class="containerTab" style="display:none;background:LightSalmon; ">
        <span onclick="this.parentElement.style.display='none'" class="closebtn">&times;</span>
        <h2>Source A</h2>
        <div>
            <!-- First model tree and it's viewer -->
            <table>
                <tr>
                    <td></td>
                    <td>
                        <form action="uploads/uploadfiles.php" method="post" enctype="multipart/form-data" target="formDestination">
                            <input id="dataSoures1" name="dataSouresName" type="file" />
                            <input id="upload1" type="submit" value="Upload">
                            <button id="load1" onclick="loadModel('dataSoures1', viewerContainer1, modelTree1)">load
                                model</button>
                        </form>
                    </td>
                </tr>
                <tr>
                    <td valign="top">
                        <div id="modelTree1"></div>
                    </td>
                    <td>
                        <div id="viewerContainer1" class="example-canvas-small"></div>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <div class="viewOrientation2">
                            <button id="Front1">Front</button>
                            <button id="Back1">Back</button>
                            <button id="Top1">Top</button>
                            <button id="Bottom1">Bottom</button>
                            <button id="Left1">Left</button>
                            <button id="Right1">Right</button>
                            <button id="Iso1">Iso</button>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div id="b2" class="containerTab" style="display:none;background:LightGreen ">
        <span onclick="this.parentElement.style.display='none'" class="closebtn">&times;</span>
        <h2>Source B</h2>
        <div>
            <!-- second model tree and it's viewer -->
            <table>
                <tr>
                    <td></td>
                    <td>
                        <form action="uploads/uploadfiles.php" method="post" enctype="multipart/form-data" target="formDestination">
                            <input id="dataSoures2" name="dataSouresName" type="file" />
                            <input id="upload2" type="submit" value="Upload">
                            <button id="load2" onclick="loadModel('dataSoures2', viewerContainer2, modelTree2)">load
                                model</button>
                        </form>
                    </td>
                </tr>
                <tr>
                    <td valign="top">
                        <div id="modelTree2"></div>
                    </td>
                    <td>
                        <div id="viewerContainer2" class="example-canvas-small"></div>
                    </td>
                </tr>
                <tr></tr>
                <tr>
                    <td></td>
                    <td>
                        <div class="viewOrientation2">
                            <button id="Front2">Front</button>
                            <button id="Back2">Back</button>
                            <button id="Top2">Top</button>
                            <button id="Bottom2">Bottom</button>
                            <button id="Left2">Left</button>
                            <button id="Right2">Right</button>
                            <button id="Iso2">Iso</button>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>


    <table id="comparisonTable">
        <tr>
            <td id="mainReviewCell" style="text-align:left;vertical-align:top;padding:0"></td>
            <td id="detailedReviewCell" style="text-align:left;vertical-align:top;padding:0"></td>
        </tr>
    </table>

    <script type="text/javascript">
        var reviewManager;
        var checkManager;
        var xCheckStudioInterface1;
        var xCheckStudioInterface2;
        var checkCaseManager;

        //to refresh check review table using table Id
        function refreshCheck() {
            //disable refresh check button
            document.getElementById("refreshCheckButton").disabled = true;

            //enable check button
            document.getElementById("checkButton").disabled = false;
            var mainReviewCellContent = document.getElementById("mainReviewCell").innerHTML;
            if (mainReviewCellContent != "") {
                document.getElementById("mainReviewCell").innerHTML = "";
            }
            var detailedReviewCellContent = document.getElementById("detailedReviewCell").innerHTML;
            if (detailedReviewCellContent != "") {
                document.getElementById("detailedReviewCell").innerHTML = "";
            }
            checkManager = undefined;
        }

        function openTab(tabName) {
            var tabs = document.getElementsByClassName("containerTab");
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].style.display = "none";
            }

            document.getElementById(tabName).style.display = "block";
        }

        function loadModel(dataSoures, viewerContainer, modelTreeContainer) {

            let selectedFiles = document.getElementById(dataSoures).files;
            let selectedFilesCount = selectedFiles.length;

            let fileName = selectedFiles[0].name;
            fileName = fileName.substring(0, fileName.lastIndexOf('.'));
            fileName += '.scs';

            var uri = "uploads/scs/" + fileName;
            var container_Id = viewerContainer.id;
            var model_Tree = modelTreeContainer.id;

            viewerOptions = {
                containerId: container_Id,
                endpointUri: uri,
                modelTree: model_Tree
            };

            if (viewerContainer.id === "viewerContainer1") {
                xCheckStudioInterface1 = new xCheckStudio.xCheckStudioInterface();
                xCheckStudioInterface1.setupViewer(viewerOptions, true);

                document.getElementById("load1").disabled = true;
                document.getElementById("upload1").disabled = true;
                document.getElementById("dataSoures1").disabled = true;
            }
            else if (viewerContainer.id === "viewerContainer2") {
                xCheckStudioInterface2 = new xCheckStudio.xCheckStudioInterface();
                xCheckStudioInterface2.setupViewer(viewerOptions, false);

                document.getElementById("load2").disabled = true;
                document.getElementById("upload2").disabled = true;
                document.getElementById("dataSoures2").disabled = true;
            }

            //enable check Button
            document.getElementById("checkButton").disabled = false;
        }

        window.onload = function () {

            var checkButton = document.getElementById("checkButton");
            checkButton.onclick = function () {
                    //disable check button 
                    document.getElementById("checkButton").disabled = true;

                    //enable refresh check Button
                    document.getElementById("refreshCheckButton").disabled = false;

                    // perform property check
                    checkManager = new CheckManager();
                    checkManager.checkDataSources(xCheckStudioInterface1.sourceProperties, xCheckStudioInterface2.sourceProperties);

                    // populate review table 
                    reviewManager = new ReviewManager(checkManager);
                    reviewManager.populateReviewTables();

                    // add event handler for collapsible rows
                    var collapsibleRows = document.getElementsByClassName("collapsible");
                    for (var i = 0; i < collapsibleRows.length; i++) {
                        collapsibleRows[i].addEventListener("click", function () {
                            this.classList.toggle("active");
                            var content = this.nextElementSibling;
                            if (content.style.display === "block") {
                                content.style.display = "none";
                            } else {
                                content.style.display = "block";
                            }
                        });
                    }
            };

            // read check case data from xml configuration file
            readCheckCaseXml();
        };

        function readCheckCaseXml() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    readCheckCaseData(this);
                }
            };

            xhttp.open("GET", "configurations/XML_2_XML_Datamapping.xml", true);
            xhttp.send();
        }

        function readCheckCaseData(xml) {
            var xmlText = xml.responseText;

            var parser = new DOMParser();
            var xmlDoc = parser.parseFromString(xmlText, "application/xml");

            var checkCaseElements = xmlDoc.getElementsByTagName("CheckCase");
            if (checkCaseElements.length < 0) {
                return;
            }

            // check case manager object
            checkCaseManager = new CheckCaseManager();

            var checkCaseElement = checkCaseElements[0];

            // CheckCase object
            var checkCase = new CheckCase(checkCaseElement.getAttribute("name"));

            for (var i = 0; i < checkCaseElement.children.length; i++) {
                var componentGroupElement = checkCaseElement.children[i];
                if (componentGroupElement.localName != "ComponentGroup") {
                    continue;
                }

                // ComponentGroup object
                var checkCaseComponentGroup = new CheckCaseComponentGroup(componentGroupElement.getAttribute("name"));

                for (var j = 0; j < componentGroupElement.children.length; j++) {
                    var componentElement = componentGroupElement.children[j];
                    if (componentElement.localName != "ComponentClass") {
                        continue;
                    }

                    // Component object
                    var checkCaseComponentClass = new CheckCaseComponentClass(componentElement.getAttribute("name"));

                    for (var k = 0; k < componentElement.children.length; k++) {
                        var propertyElement = componentElement.children[k];
                        if (propertyElement.localName != "Property") {
                            continue;
                        }

                        var sourceAProperty = propertyElement.getAttribute("sourceAName");
                        var sourceBProperty = propertyElement.getAttribute("sourceBName");
                        var severity = propertyElement.getAttribute("severity");

                        // create mapping property object 
                        var checkCaseMappingProperty = new CheckCaseMappingProperty(sourceAProperty, sourceBProperty, severity);
                        checkCaseComponentClass.addMappingProperty(checkCaseMappingProperty);
                    }

                    checkCaseComponentGroup.addComponent(checkCaseComponentClass);
                }

                checkCase.addComponentGroup(checkCaseComponentGroup);
            }
            checkCaseManager.addCheckCase(checkCase);
        }

        $(document).ready(function () {
            $('[data-toggle="toggle"]').change(function () {
                $(this).parents().next('.hide').toggle();
            });
        });



    </script>
</body>

</html>